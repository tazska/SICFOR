<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICFOR - Ingreso al Sistema</title>
    <link rel="stylesheet" href="/styles/style_login.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <div class="logo-circle">S</div>
            <h1>SICFOR</h1>
            <p>Sistema Integral de Gestión<br>Centro de Formación y Cursos</p>

            <form id="loginForm">
                <div class="input-group">
                    <i class="material-icons">person</i>
                    <input type="email" id="email" placeholder="Usuario / Email" required>
                </div>
                <div class="input-group">
                    <i class="material-icons">lock</i>
                    <input type="password" id="password" placeholder="Contraseña" required>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="remember">
                    <label for="remember">Recordar sesión</label>
                </div>

                <button type="submit" id="loginBtn" class="btn primary">INGRESAR AL SISTEMA</button>
                <a href="recuperar_contrasena.html" class="forgot-password">¿Olvidaste tu contraseña?</a>
            </form>
        </div>
    </div>
    <script>
        // Configuración
        const API_BASE_URL = window.location.origin; // http://localhost:8080

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function () {
            const loginForm = document.getElementById('loginForm');

            if (loginForm) {
                console.log('✅ Formulario de login detectado');
                inicializarLogin();
            }
        });

        function inicializarLogin() {
            const form = document.getElementById('loginForm');
            const errorDiv = document.getElementById('error-message');

            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                const loginBtn = document.getElementById('loginBtn');

                // Limpiar error
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }

                // Validar
                if (!email || !password) {
                    mostrarError('Por favor complete todos los campos');
                    return;
                }

                // Mostrar loading
                loginBtn.disabled = true;
                loginBtn.textContent = 'Ingresando...';

                try {
                    console.log('Enviando login a:', `${API_BASE_URL}/api/auth/login`);

                    const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Error desconocido');
                    }

                    if (data.success) {
                        // Guardar token y datos
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('usuario', JSON.stringify(data.usuario));

                        console.log('✅ Login exitoso! Redirigiendo según rol...');

                        // Redirigir según el rol del usuario
                        const rol = data.usuario.rol || data.usuario.rol_id;
                        
                        if (rol === 'instructor' || rol === 3) {
                            // Rol Instructor (puede ser nombre o ID 3)
                            console.log('Instructor detectado, redirigiendo a dashboard_instructor.html');
                            window.location.href = 'dashboard_instructor.html';
                        } else if (rol === 'admin' || rol === 1) {
                            // Rol Administrador
                            console.log('Administrador detectado, redirigiendo a dashboard.html');
                            window.location.href = 'dashboard.html';
                        } else if (rol === 'student' || rol === 2) {
                            // Rol Estudiante
                            console.log('Estudiante detectado, redirigiendo a dashboard_estudiante.html');
                            window.location.href = 'dashboard_estudiante.html';
                        } 
                    } else {
                        throw new Error(data.error || 'Error en el login');
                    }

                } catch (error) {
                    console.error('❌ Error:', error);
                    mostrarError(error.message);

                    // Restaurar botón
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'INGRESAR AL SISTEMA';
                }
            });
        }

        function mostrarError(mensaje) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.textContent = mensaje;
                errorDiv.style.display = 'block';
            } else {
                alert(mensaje);
            }
        }
    </script>
</body>

</html>