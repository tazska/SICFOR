<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SICFOR - Mi Perfil</title>
  <link rel="stylesheet" href="/styles/style_perfil.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
  <header class="header">
    <div class="header-left">
      <i class="material-icons menu-toggle">menu</i>
      <span class="logo">SICFOR</span>
    </div>
    <div class="header-right">
      <i class="material-icons notification-icon">notifications</i>
      <span class="notification-badge" id="notification-count">0</span>
      <div class="profile-icon" onclick="document.getElementById('profile-dropdown').classList.toggle('show')">
        <i class="material-icons">account_circle</i>
      </div>
      <span class="profile-name" id="profile-name">Cargando...</span>
      <div id="profile-dropdown" class="dropdown-content">
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </div>
  </header>

  <div class="main-container">
    <aside class="sidebar" id="sidebar">
      <!-- La barra de navegaci√≥n se cargar√° din√°micamente seg√∫n el rol -->
    </aside>

    <main class="content">
      <h2>Mi Perfil</h2>
      <div class="card">
        <div class="profile-header">
          <div class="profile-avatar"><i class="material-icons">person</i></div>
          <div class="profile-info">
            <h3 id="perfil-nombre">Cargando...</h3>
            <p class="status"><i class="material-icons">fiber_manual_record</i> En l√≠nea</p>
            <p class="id-tag" id="perfil-id">ID: ...</p>
          </div>
          <button id="editProfileBtn" class="btn primary" style="margin-left: auto;">
            <i class="material-icons">edit</i> Editar Perfil
          </button>
        </div>

        <div class="section-title">Informaci√≥n Personal</div>
        <div class="profile-details" id="perfil-detalles">
          <div style="text-align: center; padding: 20px; color: #999;">
            Cargando informaci√≥n...
          </div>
        </div>

        <div class="section-title" style="margin-top: 30px;">Seguridad</div>
        <button id="changePasswordBtn" class="btn secondary">
          <i class="material-icons">vpn_key</i> Cambiar Contrase√±a
        </button>
        <button class="btn secondary" style="margin-left: 10px;">
          <i class="material-icons">security</i> Verificaci√≥n en Dos Pasos
        </button>

        <div class="section-title" style="margin-top: 30px;">Actividad Reciente</div>
        <ul class="activity-list" id="perfil-actividad">
          <li style="color: #999; font-style: italic;">Cargando actividad...</li>
        </ul>
      </div>
    </main>
  </div>

  <script>
    // Funci√≥n para cargar la barra de navegaci√≥n seg√∫n el rol
    function cargarNavegacion(rol) {
      const sidebar = document.getElementById('sidebar');
      
      if (rol === 'instructor' || rol === 3) {
        // Barra de navegaci√≥n para Instructor
        sidebar.innerHTML = `
          <nav>
            <a href="dashboard_instructor.html"><i class="material-icons">dashboard</i> Panel de Control</a>
            <a href="perfil.html" class="active"><i class="material-icons">person</i> Mi Perfil</a>
          </nav>
        `;
      } else if (rol === 'admin' || rol === 1) {
        // Barra de navegaci√≥n para Administrador
        sidebar.innerHTML = `
          <nav>
            <a href="dashboard.html"><i class="material-icons">dashboard</i> Panel de Control</a>
            <a href="gestion_usuarios.html"><i class="material-icons">people</i> Gesti√≥n Usuarios</a>
            <a href="gestion_roles.html"><i class="material-icons">lock</i> Gesti√≥n Roles</a>
            <a href="perfil.html" style="background-color: #f0f0f0; font-weight: bold;">
              <i class="material-icons">person</i> Mi Perfil
            </a>
          </nav>
        `;
      } else if (rol === 'student' || rol === 2) {
        // Barra de navegaci√≥n para Estudiante
        sidebar.innerHTML = `
          <nav>
            <a href="dashboard_estudiante.html"><i class="material-icons">dashboard</i> Panel de Control</a>
            <a href="perfil.html" class="active"><i class="material-icons">person</i> Mi Perfil</a>
          </nav>
        `;
      } else {
        // Barra por defecto si no se reconoce el rol
        sidebar.innerHTML = `
          <nav>
            <a href="dashboard.html"><i class="material-icons">dashboard</i> Panel de Control</a>
            <a href="perfil.html" class="active"><i class="material-icons">person</i> Mi Perfil</a>
          </nav>
        `;
      }
      
      console.log('‚úÖ Barra de navegaci√≥n cargada para rol:', rol);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ Cargando perfil de usuario...');

      // Verificar sesi√≥n
      const usuarioSesion = JSON.parse(localStorage.getItem('usuario'));
      if (!usuarioSesion) {
        console.log('‚ùå No hay sesi√≥n activa, redirigiendo a login');
        window.location.href = 'login.html';
        return;
      }

      console.log('‚úÖ Usuario en sesi√≥n:', usuarioSesion);

      // Cargar la barra de navegaci√≥n seg√∫n el rol
      cargarNavegacion(usuarioSesion.rol || usuarioSesion.rol_id);

      // Mostrar nombre en el header
      document.getElementById('profile-name').textContent = usuarioSesion.nombre;

      // Configurar bot√≥n de editar perfil
      document.getElementById('editProfileBtn').addEventListener('click', () => {
        console.log('‚úèÔ∏è Redirigiendo a editar perfil:', usuarioSesion.id);
        window.location.href = `editar_usuario.html?id=${usuarioSesion.id}`;
      });

      try {
        // Cargar datos del perfil
        console.log(`üì° Obteniendo perfil de ID: ${usuarioSesion.id}`);
        const res = await fetch(`/api/perfil/${usuarioSesion.id}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        console.log('üì¶ Respuesta del servidor:', data);

        if (data.success && data.usuario) {
          const u = data.usuario;
          console.log('‚úÖ Datos del usuario cargados:', u);

          // Actualizar nombre e ID
          document.getElementById('perfil-nombre').textContent = u.nombre || 'N/A';
          document.getElementById('perfil-id').textContent = `ID: ${u.id || 'N/A'}`;

          // Actualizar detalles del perfil
          document.getElementById('perfil-detalles').innerHTML = `
        <div class="detail-item"><label>ID:</label><span>${u.id || 'N/A'}</span></div>
        <div class="detail-item"><label>Rol asignado:</label><span class="tag role-${u.rol || 'unknown'}">${u.rol || 'N/A'}</span></div>
        <div class="detail-item"><label>Documento:</label><span>${u.documento_identidad || 'N/A'}</span></div>
        <div class="detail-item"><label>Estado de cuenta:</label><span class="tag ${u.estado === 'active' ? 'active' : 'inactive'}">${u.estado === 'active' ? 'Activo' : 'Inactivo'}</span></div>
        <div class="detail-item"><label>Email:</label><a href="mailto:${u.email || ''}">${u.email || 'N/A'}</a></div>
        <div class="detail-item"><label>Departamento:</label><span>${u.departamento || 'N/A'}</span></div>
        <div class="detail-item"><label>Tel√©fono:</label><span>${u.telefono || 'N/A'}</span></div>
        <div class="detail-item"><label>Ubicaci√≥n:</label><span>${u.ubicacion || 'N/A'}</span></div>
        <div class="detail-item"><label>Fecha de registro:</label><span>${u.fecha_registro ? new Date(u.fecha_registro).toLocaleDateString('es-ES') : 'N/A'}</span></div>
      `;

          console.log('‚úÖ Informaci√≥n del perfil renderizada correctamente');
        } else {
          console.error('‚ùå Error al cargar perfil:', data.error);
          document.getElementById('perfil-detalles').innerHTML =
            '<div style="text-align:center; padding:20px; color:#d32f2f;">Error al cargar la informaci√≥n del perfil</div>';
        }

        // Cargar actividad reciente
        console.log(`üì° Obteniendo actividad de ID: ${usuarioSesion.id}`);
        const actividadRes = await fetch(`/api/actividad/${usuarioSesion.id}`);
        if (!actividadRes.ok) throw new Error(`HTTP ${actividadRes.status}`);
        const actividadData = await actividadRes.json();

        console.log('üì¶ Actividad del usuario:', actividadData);

        const lista = document.getElementById('perfil-actividad');
        if (actividadData.success && actividadData.actividad && actividadData.actividad.length > 0) {
          lista.innerHTML = '';
          actividadData.actividad.forEach(act => {
            const li = document.createElement('li');
            li.innerHTML = `
          <i class="material-icons" style="color:#2ecc71; font-size:16px;">fiber_manual_record</i>
          ${new Date(act.creado_en).toLocaleString('es-ES')} - ${act.descripcion || 'Sin descripci√≥n'}
        `;
            lista.appendChild(li);
          });
          console.log(`‚úÖ ${actividadData.actividad.length} actividades renderizadas`);
        } else {
          lista.innerHTML = '<li style="color:#999; font-style:italic;">No hay actividad reciente</li>';
          console.log('‚ö†Ô∏è No hay actividad reciente para mostrar');
        }

      } catch (err) {
        console.error('‚ùå Error al cargar perfil:', err);
        document.getElementById('perfil-detalles').innerHTML =
          '<div style="text-align:center; padding:20px; color:#d32f2f;">Error de conexi√≥n con el servidor</div>';
        document.getElementById('perfil-actividad').innerHTML =
          '<li style="color:#d32f2f;">Error al cargar actividad</li>';
      }
    });

    function logout() {
      console.log('üëã Cerrando sesi√≥n...');
      localStorage.removeItem('token');
      localStorage.removeItem('usuario');
      window.location.href = 'login.html';
    }
  </script>

</body>

</html>