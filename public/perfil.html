<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SICFOR - Mi Perfil</title>
  <link rel="stylesheet" href="/styles/style_perfil.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
  <header class="header">
    <div class="header-left">
      <i class="material-icons menu-toggle">menu</i>
      <span class="logo">SICFOR</span>
    </div>
    <div class="header-right">
      <i class="material-icons notification-icon">notifications</i>
      <span class="notification-badge" id="notification-count">0</span>
      <div class="profile-icon" onclick="document.getElementById('profile-dropdown').classList.toggle('show')">
        <i class="material-icons">account_circle</i>
      </div>
      <span class="profile-name" id="profile-name">Cargando...</span>
      <div id="profile-dropdown" class="dropdown-content">
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </div>
  </header>

  <div class="main-container">
    <aside class="sidebar" id="sidebar">
      <!-- La barra de navegaci√≥n se cargar√° din√°micamente seg√∫n el rol -->
    </aside>

    <main class="content">
      <h2>Mi Perfil</h2>
      <div class="card">
        <div class="profile-header">
          <div class="profile-avatar"><i class="material-icons">person</i></div>
          <div class="profile-info">
            <h3 id="perfil-nombre">Cargando...</h3>
            <p class="status"><i class="material-icons">fiber_manual_record</i> En l√≠nea</p>
            <p class="id-tag" id="perfil-id">ID: ...</p>
          </div>
          <button id="editProfileBtn" class="btn primary" style="margin-left: auto;">
            <i class="material-icons">edit</i> Editar Perfil
          </button>
        </div>

        <div class="section-title">Informaci√≥n Personal</div>
        <div class="profile-details" id="perfil-detalles">
          <div style="text-align: center; padding: 20px; color: #999;">
            Cargando informaci√≥n...
          </div>
        </div>

        <div class="section-title" style="margin-top: 30px;">Seguridad</div>
        <button id="changePasswordBtn" class="btn secondary">
          <i class="material-icons">vpn_key</i> Cambiar Contrase√±a
        </button>

        <div class="section-title" style="margin-top: 30px;">Actividad Reciente</div>
        <ul class="activity-list" id="perfil-actividad">
          <li style="color: #999; font-style: italic;">Cargando actividad...</li>
        </ul>
      </div>
    </main>
  </div>

  <!-- Modal de Cambiar Contrase√±a -->
  <div id="changePasswordModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="material-icons">vpn_key</i> Cambiar Contrase√±a</h3>
        <button class="close" onclick="cerrarModalPassword()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="alertMessage" class="alert"></div>
        
        <form id="changePasswordForm">
          <div class="form-group">
            <label for="currentPassword">Contrase√±a Actual *</label>
            <div class="password-input-wrapper">
              <input type="password" id="currentPassword" name="currentPassword" required>
              <button type="button" class="toggle-password" onclick="togglePasswordVisibility('currentPassword')">
                <i class="material-icons">visibility</i>
              </button>
            </div>
          </div>

          <div class="form-group">
            <label for="newPassword">Nueva Contrase√±a *</label>
            <div class="password-input-wrapper">
              <input type="password" id="newPassword" name="newPassword" required>
              <button type="button" class="toggle-password" onclick="togglePasswordVisibility('newPassword')">
                <i class="material-icons">visibility</i>
              </button>
            </div>
            <div class="password-requirements">
              <strong>La contrase√±a debe contener:</strong>
              <ul id="passwordRequirements">
                <li id="req-length">Al menos 8 caracteres</li>
                <li id="req-uppercase">Una letra may√∫scula</li>
                <li id="req-lowercase">Una letra min√∫scula</li>
                <li id="req-number">Un n√∫mero</li>
              </ul>
            </div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirmar Nueva Contrase√±a *</label>
            <div class="password-input-wrapper">
              <input type="password" id="confirmPassword" name="confirmPassword" required>
              <button type="button" class="toggle-password" onclick="togglePasswordVisibility('confirmPassword')">
                <i class="material-icons">visibility</i>
              </button>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="cerrarModalPassword()">Cancelar</button>
        <button class="btn primary" onclick="cambiarPassword()">
          <i class="material-icons">save</i> Guardar Cambios
        </button>
      </div>
    </div>
  </div>

  <script>
    // Funci√≥n para cargar la barra de navegaci√≥n seg√∫n el rol
    function cargarNavegacion(rol) {
      const sidebar = document.getElementById('sidebar');
      
      if (rol === 'instructor' || rol === 3) {
        sidebar.innerHTML = `
          <nav>
            <a href="dashboard_instructor.html"><i class="material-icons">dashboard</i> Panel de Control</a>
            <a href="perfil.html" class="active"><i class="material-icons">person</i> Mi Perfil</a>
          </nav>
        `;
      } else if (rol === 'admin' || rol === 1) {
        sidebar.innerHTML = `
          <nav>
            <a href="dashboard.html"><i class="material-icons">dashboard</i> Panel de Control</a>
            <a href="gestion_usuarios.html"><i class="material-icons">people</i> Gesti√≥n Usuarios</a>
            <a href="gestion_roles.html"><i class="material-icons">lock</i> Gesti√≥n Roles</a>
            <a href="perfil.html" style="background-color: #f0f0f0; font-weight: bold;">
              <i class="material-icons">person</i> Mi Perfil
            </a>
          </nav>
        `;
      } else if (rol === 'student' || rol === 2) {
        sidebar.innerHTML = `
          <nav>
            <a href="dashboard_estudiante.html"><i class="material-icons">dashboard</i> Panel de Control</a>
            <a href="perfil.html" class="active"><i class="material-icons">person</i> Mi Perfil</a>
          </nav>
        `;
      }
      console.log('‚úÖ Barra de navegaci√≥n cargada para rol:', rol);
    }

    // Funciones para el modal de cambiar contrase√±a
    function abrirModalPassword() {
      document.getElementById('changePasswordModal').style.display = 'block';
      document.getElementById('changePasswordForm').reset();
      document.getElementById('alertMessage').style.display = 'none';
    }

    function cerrarModalPassword() {
      document.getElementById('changePasswordModal').style.display = 'none';
      document.getElementById('changePasswordForm').reset();
      document.getElementById('alertMessage').style.display = 'none';
    }

    function togglePasswordVisibility(inputId) {
      const input = document.getElementById(inputId);
      const button = input.nextElementSibling;
      const icon = button.querySelector('i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'visibility_off';
      } else {
        input.type = 'password';
        icon.textContent = 'visibility';
      }
    }

    function mostrarAlerta(mensaje, tipo) {
      const alertDiv = document.getElementById('alertMessage');
      alertDiv.textContent = mensaje;
      alertDiv.className = `alert ${tipo}`;
      alertDiv.style.display = 'block';
      
      // Auto-ocultar despu√©s de 5 segundos
      setTimeout(() => {
        alertDiv.style.display = 'none';
      }, 5000);
    }

    // Validaci√≥n en tiempo real de la contrase√±a
    document.addEventListener('DOMContentLoaded', () => {
      const newPasswordInput = document.getElementById('newPassword');
      
      if (newPasswordInput) {
        newPasswordInput.addEventListener('input', function() {
          const password = this.value;
          
          // Validar longitud
          const lengthValid = password.length >= 8;
          document.getElementById('req-length').className = lengthValid ? 'valid' : 'invalid';
          
          // Validar may√∫scula
          const uppercaseValid = /[A-Z]/.test(password);
          document.getElementById('req-uppercase').className = uppercaseValid ? 'valid' : 'invalid';
          
          // Validar min√∫scula
          const lowercaseValid = /[a-z]/.test(password);
          document.getElementById('req-lowercase').className = lowercaseValid ? 'valid' : 'invalid';
          
          // Validar n√∫mero
          const numberValid = /[0-9]/.test(password);
          document.getElementById('req-number').className = numberValid ? 'valid' : 'invalid';
        });
      }
    });

    async function cambiarPassword() {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validaciones del cliente
      if (!currentPassword || !newPassword || !confirmPassword) {
        mostrarAlerta('Por favor, completa todos los campos', 'error');
        return;
      }

      if (newPassword !== confirmPassword) {
        mostrarAlerta('Las contrase√±as no coinciden', 'error');
        return;
      }

      if (newPassword.length < 8) {
        mostrarAlerta('La contrase√±a debe tener al menos 8 caracteres', 'error');
        return;
      }

      if (!/[A-Z]/.test(newPassword)) {
        mostrarAlerta('La contrase√±a debe contener al menos una may√∫scula', 'error');
        return;
      }

      if (!/[a-z]/.test(newPassword)) {
        mostrarAlerta('La contrase√±a debe contener al menos una min√∫scula', 'error');
        return;
      }

      if (!/[0-9]/.test(newPassword)) {
        mostrarAlerta('La contrase√±a debe contener al menos un n√∫mero', 'error');
        return;
      }

      if (currentPassword === newPassword) {
        mostrarAlerta('La nueva contrase√±a debe ser diferente a la actual', 'error');
        return;
      }

      try {
        const usuarioSesion = JSON.parse(localStorage.getItem('usuario'));
        console.log('üîÑ Cambiando contrase√±a para usuario:', usuarioSesion.id);

        const response = await fetch('/api/cambiar-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            usuario_id: usuarioSesion.id,
            password_actual: currentPassword,
            password_nueva: newPassword
          })
        });

        const data = await response.json();

        if (data.success) {
          console.log('‚úÖ Contrase√±a cambiada exitosamente');
          mostrarAlerta('Contrase√±a actualizada correctamente', 'success');
          
          // Cerrar modal despu√©s de 2 segundos
          setTimeout(() => {
            cerrarModalPassword();
          }, 2000);
        } else {
          console.error('‚ùå Error al cambiar contrase√±a:', data.error);
          mostrarAlerta(data.error || 'Error al cambiar la contrase√±a', 'error');
        }
      } catch (error) {
        console.error('‚ùå Error de conexi√≥n:', error);
        mostrarAlerta('Error de conexi√≥n con el servidor', 'error');
      }
    }

    // Cerrar modal al hacer clic fuera de √©l
    window.onclick = function(event) {
      const modal = document.getElementById('changePasswordModal');
      if (event.target === modal) {
        cerrarModalPassword();
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ Cargando perfil de usuario...');

      // Verificar sesi√≥n
      const usuarioSesion = JSON.parse(localStorage.getItem('usuario'));
      if (!usuarioSesion) {
        console.log('‚ùå No hay sesi√≥n activa, redirigiendo a login');
        window.location.href = 'login.html';
        return;
      }

      console.log('‚úÖ Usuario en sesi√≥n:', usuarioSesion);

      // Cargar la barra de navegaci√≥n seg√∫n el rol
      cargarNavegacion(usuarioSesion.rol || usuarioSesion.rol_id);

      // Mostrar nombre en el header
      document.getElementById('profile-name').textContent = usuarioSesion.nombre;

      // Configurar bot√≥n de editar perfil
      document.getElementById('editProfileBtn').addEventListener('click', () => {
        console.log('‚úèÔ∏è Redirigiendo a editar perfil:', usuarioSesion.id);
        window.location.href = `editar_usuario.html?id=${usuarioSesion.id}&from=perfil`;
      });

      // Configurar bot√≥n de cambiar contrase√±a
      document.getElementById('changePasswordBtn').addEventListener('click', abrirModalPassword);

      try {
        // Cargar datos del perfil
        console.log(`üì° Obteniendo perfil de ID: ${usuarioSesion.id}`);
        const res = await fetch(`/api/perfil/${usuarioSesion.id}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        console.log('üì¶ Respuesta del servidor:', data);

        if (data.success && data.usuario) {
          const u = data.usuario;
          console.log('‚úÖ Datos del usuario cargados:', u);

          // Actualizar nombre e ID
          document.getElementById('perfil-nombre').textContent = u.nombre || 'N/A';
          document.getElementById('perfil-id').textContent = `ID: ${u.id || 'N/A'}`;

          // Actualizar detalles del perfil
          document.getElementById('perfil-detalles').innerHTML = `
            <div class="detail-item"><label>ID:</label><span>${u.id || 'N/A'}</span></div>
            <div class="detail-item"><label>Rol asignado:</label><span class="tag role-${u.rol || 'unknown'}">${u.rol || 'N/A'}</span></div>
            <div class="detail-item"><label>Documento:</label><span>${u.documento_identidad || 'N/A'}</span></div>
            <div class="detail-item"><label>Estado de cuenta:</label><span class="tag ${u.estado === 'active' ? 'active' : 'inactive'}">${u.estado === 'active' ? 'Activo' : 'Inactivo'}</span></div>
            <div class="detail-item"><label>Email:</label><a href="mailto:${u.email || ''}">${u.email || 'N/A'}</a></div>
            <div class="detail-item"><label>Departamento:</label><span>${u.departamento || 'N/A'}</span></div>
            <div class="detail-item"><label>Tel√©fono:</label><span>${u.telefono || 'N/A'}</span></div>
            <div class="detail-item"><label>Ubicaci√≥n:</label><span>${u.ubicacion || 'N/A'}</span></div>
            <div class="detail-item"><label>Fecha de registro:</label><span>${u.fecha_registro ? new Date(u.fecha_registro).toLocaleDateString('es-ES') : 'N/A'}</span></div>
          `;

          console.log('‚úÖ Informaci√≥n del perfil renderizada correctamente');
        } else {
          console.error('‚ùå Error al cargar perfil:', data.error);
          document.getElementById('perfil-detalles').innerHTML =
            '<div style="text-align:center; padding:20px; color:#d32f2f;">Error al cargar la informaci√≥n del perfil</div>';
        }

        // Cargar actividad reciente
        console.log(`üì° Obteniendo actividad de ID: ${usuarioSesion.id}`);
        const actividadRes = await fetch(`/api/actividad/${usuarioSesion.id}`);
        if (!actividadRes.ok) throw new Error(`HTTP ${actividadRes.status}`);
        const actividadData = await actividadRes.json();

        console.log('üì¶ Actividad del usuario:', actividadData);

        const lista = document.getElementById('perfil-actividad');
        if (actividadData.success && actividadData.actividad && actividadData.actividad.length > 0) {
          lista.innerHTML = '';
          actividadData.actividad.forEach(act => {
            const li = document.createElement('li');
            li.innerHTML = `
              <i class="material-icons" style="color:#2ecc71; font-size:16px;">fiber_manual_record</i>
              ${new Date(act.creado_en).toLocaleString('es-ES')} - ${act.descripcion || 'Sin descripci√≥n'}
            `;
            lista.appendChild(li);
          });
          console.log(`‚úÖ ${actividadData.actividad.length} actividades renderizadas`);
        } else {
          lista.innerHTML = '<li style="color:#999; font-style:italic;">No hay actividad reciente</li>';
          console.log('‚ö†Ô∏è No hay actividad reciente para mostrar');
        }

      } catch (err) {
        console.error('‚ùå Error al cargar perfil:', err);
        document.getElementById('perfil-detalles').innerHTML =
          '<div style="text-align:center; padding:20px; color:#d32f2f;">Error de conexi√≥n con el servidor</div>';
        document.getElementById('perfil-actividad').innerHTML =
          '<li style="color:#d32f2f;">Error al cargar actividad</li>';
      }
    });

    function logout() {
      console.log('üëã Cerrando sesi√≥n...');
      localStorage.removeItem('token');
      localStorage.removeItem('usuario');
      window.location.href = 'login.html';
    }
  </script>

</body>

</html>